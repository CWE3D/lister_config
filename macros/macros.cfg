[gcode_macro ECHO_LISTER_VARS]
description: Echo Lister variables to the console.
gcode:
    {% for var, value in printer["gcode_macro Lister"].items() %}
        {action_respond_info(var ~ ": " ~ value)}
    {% endfor %}
    
[gcode_macro Lister]
description: Lister variable storage macro, will echo variables to the console when run.
# Configuration Defaults
# This is only here to make the config backwards compatible.
# Configuration should exclusively happen in printer.cfg.

# Lister
variable_nozzle_pid_temp: 200
variable_bed_pid_temp: 75
variable_park_x: 0  # X position to park, adjust as needed
variable_park_y: -15  # Y position to park, adjust as needed
variable_object_height: 65  # Maximum height of objects in multi-object prints

gcode:
    ECHO_LISTER_VARS

[gcode_macro DISABLE_X_Y_STEPPERS]
description: Turns off X and Y steppers.
gcode:
    RESPOND MSG="Disabling X and Y steppers"
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0

[gcode_macro BED_PROBE_MANUAL_ADJUST]
description: This will help you adjust the base for the bed with the help of a probe. It will tell you how to turn the screws at the bottom of the bed.
gcode:
    RESPOND MSG="Starting bed probe manual adjustment"
    MAYBE_HOME
    SCREWS_TILT_CALCULATE

[gcode_macro COLD_CHANGE_FILAMENT]
description: Change filament routine
variable_default_temp: 220
gcode:
    {% set NOZZLE_TEMP = params.TEMP|default(default_temp)|float %}
    RESPOND MSG="Starting filament change routine"
    M104 S{NOZZLE_TEMP} ; Set nozzle to the specified temperature
    M109 S{NOZZLE_TEMP} ; Wait for nozzle to reach the specified temperature
    RESPOND MSG="Nozzle at temperature, proceeding with filament change"
    M83 ; Set extruder to relative mode
    G91 ; Set all axes to relative mode
    G1 E-10 F300 ; Retract 10mm
    G1 E5 F300 ; Extrude 5mm
    G1 E-10 F300 ; Retract 10mm
    G1 E5 F300 ; Extrude 5mm
    G1 E-15 F300 ; Retract 15mm
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    RESPOND MSG="Filament change complete, waiting for 5 minutes"
    G4 P300000 ; Wait for 5 minutes (300000 milliseconds)
    M104 S0 ; Turn off the nozzle heater
    RESPOND MSG="Filament change process finished"

[gcode_macro _FILAMENT_RAN_OUT]
description: Continue printing for specified distance after runout, then pause and purge
variable_purge_length: 50  # Default length to purge after pausing
gcode:
    {% set CONTINUE_PRINT_DISTANCE = params.CONTINUE_PRINT_DISTANCE|default(300)|float %}
    {% set purge_length = printer["gcode_macro _FILAMENT_RAN_OUT"].purge_length|float %}
    
    # Continue printing for the specified distance
    RESPOND MSG="Continuing to print for {CONTINUE_PRINT_DISTANCE}mm after runout detection"
    G91  # Relative positioning
    G1 E{CONTINUE_PRINT_DISTANCE} F{printer.configfile.settings.extruder.max_extrude_only_velocity|float * 60}
    G90  # Absolute positioning
    
    # Now pause the print
    RESPOND MSG="Specified distance reached. Pausing print."
    PAUSE
    
    # Heat up the nozzle if it's not already hot
    {% if printer.extruder.temperature < printer.extruder.target %}
        RESPOND MSG="Heating nozzle to target temperature"
        M109 S{printer.extruder.target}
    {% endif %}
    
    # Purge remaining filament
    RESPOND MSG="Purging remaining {purge_length}mm of filament"
    M83 ; Set extruder to relative mode
    G1 E{purge_length} F300 ; Extrude at 5mm/s (300mm/min)
    G1 E-2 F1800 ; Retract 2mm to prevent oozing
    
    # Disable the extruder stepper
    RESPOND MSG="Disabling extruder stepper"
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    
    RESPOND MSG="Filament change required. Please insert new filament."

[gcode_macro _FILAMENT_INSERTED]
description: Routine to handle filament insertion
gcode:
    {% set PURGE_LENGTH = params.PURGE_LENGTH|default(100)|float %}
    {% set DELAY_BEFORE_EXTRUDE = params.DELAY_BEFORE_EXTRUDE|default(5)|int %}
    {% set SLOW_EXTRUDE_LENGTH = 20 %}  # Length to extrude slowly to grab filament
    {% set FAST_PURGE_LENGTH = PURGE_LENGTH - SLOW_EXTRUDE_LENGTH %}  # Remaining length for fast purge

    RESPOND MSG="Filament inserted. Starting insertion process in {DELAY_BEFORE_EXTRUDE} seconds."
    G4 P{DELAY_BEFORE_EXTRUDE * 1000}  # Wait for specified delay in milliseconds

    # Ensure the nozzle is at the target temperature
    {% if printer.extruder.temperature < printer.extruder.target %}
        RESPOND MSG="Heating nozzle to target temperature"
        M109 S{printer.extruder.target}
    {% endif %}

    M83  # Set extruder to relative mode

    # Slow extrusion to grab filament
    RESPOND MSG="Slowly extruding to grab filament"
    G1 E{SLOW_EXTRUDE_LENGTH} F60  # Extrude at 1mm/s

    # Faster extrusion to purge
    RESPOND MSG="Purging filament"
    G1 E{FAST_PURGE_LENGTH} F300  # Extrude at 5mm/s

    G1 E-2 F1800  # Retract 2mm to prevent oozing

    RESPOND MSG="Filament insertion complete"
    RESPOND MSG="Resume the print when ready"


[gcode_macro TUNE_NOZZLE_PID]
description: Runs calibration for PID values on extruder.
gcode:
    {% set TARGET_TEMP = printer["gcode_macro Lister"].nozzle_pid_temp|float %}
    RESPOND MSG="Starting nozzle PID tuning at {TARGET_TEMP}°C"
    PID_CALIBRATE HEATER=extruder TARGET={TARGET_TEMP}
    RESPOND MSG="Nozzle PID tuning complete, saving configuration"
    SAVE_CONFIG

[gcode_macro TUNE_BED_PID]
description: Runs calibration for PID values on bed.
gcode:
    {% set TARGET_TEMP = printer["gcode_macro Lister"].bed_pid_temp|default(60)|float %}
    RESPOND MSG="Starting bed PID tuning at {TARGET_TEMP}°C"
    PID_CALIBRATE HEATER=heater_bed TARGET={TARGET_TEMP}
    RESPOND MSG="Bed PID tuning complete, saving configuration"
    SAVE_CONFIG

[gcode_macro TURN_ON_LIGHT]
description: Turns on the printer light
gcode:
    RESPOND MSG="Turning on light"
    SET_PIN PIN=light_led VALUE=1

[gcode_macro TURN_LOW_LIGHT]
description: Sets the printer light to low intensity
gcode:
    RESPOND MSG="Setting light to low intensity"
    SET_PIN PIN=light_led VALUE=.4

[gcode_macro TURN_OFF_LIGHT]
description: Turns off the printer light
gcode:
    RESPOND MSG="Turning off light"
    SET_PIN PIN=light_led VALUE=0